#!/bin/bash

echo "🚀 Iniciando a configuração do projeto..."

# Verifica se Docker e Docker Compose estão instalados
if ! command -v docker &> /dev/null || ! command -v docker-compose &> /dev/null
then
    echo "❌ Docker e Docker Compose precisam estar instalados."
    exit 1
fi

# Derruba e recria os containers
echo "📦 Subindo os containers do Docker..."
docker-compose down --remove-orphans
docker-compose up -d --build

# Aguarda o MySQL iniciar
echo "⏳ Aguardando MySQL iniciar..."
sleep 10

# Executa os comandos dentro do container da aplicação
echo "🔧 Rodando setup dentro do container..."
docker exec -it salesflow_php bash -c "
    echo '🔑 Gerando a APP_KEY...'
    php artisan key:generate

    echo '🔄 Limpando caches...'
    php artisan cache:clear && php artisan config:clear && php artisan route:clear && php artisan view:clear

    echo '🎲 Rodando as migrações...'
    php artisan migrate --force

    echo '🌱 Rodando os seeders...'
    php artisan db:seed

    echo '📂 Ajustando permissões...'
    chmod -R 777 storage bootstrap/cache
"

echo "✅ Configuração concluída! O projeto está pronto para uso."
